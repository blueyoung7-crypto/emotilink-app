<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardioGuard AI - Live EmotiBit Data</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .connection-status {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #ddd;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected { background: #00b894; }
        .status-connecting { background: #fdcb6e; }
        .status-disconnected { background: #e17055; }

        .vitals-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .vital-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 5px solid #ff6b6b;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .vital-value {
            font-size: 2em;
            font-weight: bold;
            color: #ff6b6b;
            margin: 10px 0;
        }

        .vital-label {
            color: #666;
            font-size: 0.9em;
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .data-stream {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }

        .log-timestamp {
            color: #666;
            font-size: 0.8em;
        }

        .log-data {
            color: #333;
        }

        .btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .ai-insights {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .footer {
            text-align: center;
            color: white;
            opacity: 0.8;
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ù§Ô∏è CardioGuard AI</h1>
            <div class="subtitle">Real-Time EmotiBit Integration - HTTP Version</div>
            <div class="company">Live Physiological Monitoring</div>
        </div>

        <div class="main-content">
            <div class="connection-status" id="connectionStatus">
                <h3><span class="status-indicator status-connecting" id="statusIndicator"></span>Connecting to EmotiBit Bridge...</h3>
                <p id="connectionMessage">Fetching data from bridge server...</p>
                <div style="margin-top: 10px;">
                    <button class="btn" onclick="reconnectToBridge()">üîÑ Reconnect</button>
                    <button class="btn" onclick="openBridgeStatus()">üîß Bridge Status</button>
                </div>
            </div>

            <div class="vitals-display">
                <div class="vital-card">
                    <div class="vital-label">Heart Rate (Real)</div>
                    <div class="vital-value pulse-animation" id="heartRate">--</div>
                    <div class="vital-label">BPM <span id="hrStatus">(No data)</span></div>
                </div>
                <div class="vital-card">
                    <div class="vital-label">HRV RMSSD (Real)</div>
                    <div class="vital-value" id="hrvScore">--</div>
                    <div class="vital-label">ms <span id="hrvStatus">(No data)</span></div>
                </div>
                <div class="vital-card">
                    <div class="vital-label">EDA Tonic (Real)</div>
                    <div class="vital-value" id="edaValue">--</div>
                    <div class="vital-label">ŒºS <span id="edaStatus">(No data)</span></div>
                </div>
                <div class="vital-card">
                    <div class="vital-label">Activity Level (Real)</div>
                    <div class="vital-value" id="activityLevel">--</div>
                    <div class="vital-label">g-force <span id="activityStatus">(No data)</span></div>
                </div>
            </div>

            <div class="ai-insights">
                <h3>üß† Real-Time AI Analysis (Real Data Only)</h3>
                <p id="aiInsight">Waiting for real EmotiBit sensor data to provide intelligent health insights...</p>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="requestAIAnalysis()">ü§ñ Analyze Real Data</button>
                    <button class="btn" onclick="exportRealData()">üìä Export Real Data</button>
                </div>
                <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;" id="dataQuality">
                    Signal Quality: Waiting for real sensor data...
                </div>
            </div>

            <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3>üìä Live Data Stream (Real EmotiBit Data)</h3>
                <div class="data-stream" id="dataStream">
                    <div class="log-entry">
                        <span class="log-timestamp">[Waiting]</span>
                        <span class="log-data">Connecting to EmotiBit bridge server...</span>
                    </div>
                </div>
                <button class="btn" onclick="clearDataStream()">üóëÔ∏è Clear Log</button>
            </div>

            <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3>üîß Real Data Setup Status</h3>
                <div id="setupStatus">
                    <p>‚úÖ Bridge server running on HTTP (not WebSocket)</p>
                    <p>‚è≥ Checking for real EmotiBit data...</p>
                    <p>üîç No simulation - real sensor data only</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>CardioGuard AI - Real EmotiBit Data Integration</p>
            <p>HTTP Polling Version - No Simulated Data</p>
        </div>
    </div>

    <script>
        let pollingInterval = null;
        let lastDataTime = 0;
        let realDataBuffer = [];
        let isConnected = false;

        function startDataPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            pollingInterval = setInterval(fetchRealData, 2000);
            fetchRealData();
        }

        function fetchRealData() {
            const statusIndicator = document.getElementById('statusIndicator');
            const connectionMessage = document.getElementById('connectionMessage');
            
            fetch('http://localhost:8080/data')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.type === 'sensor_data') {
                        processRealSensorData(data);
                        isConnected = true;
                        statusIndicator.className = 'status-indicator status-connected';
                        connectionMessage.textContent = `Connected - Real data (${data.data.packets_received} packets)`;
                    }
                })
                .catch(error => {
                    console.error('Failed to fetch real data:', error);
                    isConnected = false;
                    statusIndicator.className = 'status-indicator status-disconnected';
                    connectionMessage.textContent = 'Cannot connect to bridge server - Make sure it\'s running';
                    showNoDataState();
                });
        }

        function processRealSensorData(data) {
            const sensorData = data.data;
            lastDataTime = Date.now();
            
            if (sensorData.connection_status === 'disconnected') {
                showDisconnectedState();
                addRealDataToStream({
                    packets_received: sensorData.packets_received,
                    connection_status: 'disconnected'
                });
                return;
            }
            
            if (sensorData.packets_received > 0 && sensorData.connection_status === 'connected') {
                updateVitalSigns(sensorData);
                addRealDataToStream(sensorData);
                updateAIWithRealData(sensorData);
                
                realDataBuffer.push(sensorData);
                if (realDataBuffer.length > 1000) {
                    realDataBuffer.shift();
                }
            } else {
                showWaitingState();
            }
        }

        function updateVitalSigns(data) {
            if (data.heart_rate !== null && data.heart_rate !== undefined) {
                document.getElementById('heartRate').textContent = data.heart_rate;
                document.getElementById('hrStatus').textContent = `(Real - ${getHeartRateStatus(data.heart_rate)})`;
            } else {
                document.getElementById('heartRate').textContent = '--';
                document.getElementById('hrStatus').textContent = '(No real data)';
            }
            
            if (data.hrv_rmssd !== null && data.hrv_rmssd !== undefined) {
                document.getElementById('hrvScore').textContent = data.hrv_rmssd;
                document.getElementById('hrvStatus').textContent = `(Real - ${getHRVStatus(data.hrv_rmssd)})`;
            } else {
                document.getElementById('hrvScore').textContent = '--';
                document.getElementById('hrvStatus').textContent = '(No real data)';
            }
            
            if (data.eda_tonic !== null && data.eda_tonic !== undefined) {
                document.getElementById('edaValue').textContent = data.eda_tonic.toFixed(3);
                document.getElementById('edaStatus').textContent = `(Real - ${getEDAStatus(data.eda_tonic)})`;
            } else {
                document.getElementById('edaValue').textContent = '--';
                document.getElementById('edaStatus').textContent = '(No real data)';
            }
            
            if (data.activity_level !== null && data.activity_level !== undefined) {
                document.getElementById('activityLevel').textContent = data.activity_level.toFixed(3);
                document.getElementById('activityStatus').textContent = `(Real - ${getActivityStatus(data.activity_level)})`;
            } else {
                document.getElementById('activityLevel').textContent = '--';
                document.getElementById('activityStatus').textContent = '(No real data)';
            }
        }

        function showNoDataState() {
            document.getElementById('heartRate').textContent = '--';
            document.getElementById('hrStatus').textContent = '(Bridge disconnected)';
            document.getElementById('hrvScore').textContent = '--';
            document.getElementById('hrvStatus').textContent = '(Bridge disconnected)';
            document.getElementById('edaValue').textContent = '--';
            document.getElementById('edaStatus').textContent = '(Bridge disconnected)';
            document.getElementById('activityLevel').textContent = '--';
            document.getElementById('activityStatus').textContent = '(Bridge disconnected)';
        }

        function showDisconnectedState() {
            document.getElementById('heartRate').textContent = '--';
            document.getElementById('hrStatus').textContent = '(Sensor disconnected)';
            document.getElementById('hrvScore').textContent = '--';
            document.getElementById('hrvStatus').textContent = '(Sensor disconnected)';
            document.getElementById('edaValue').textContent = '--';
            document.getElementById('edaStatus').textContent = '(Sensor disconnected)';
            document.getElementById('activityLevel').textContent = '--';
            document.getElementById('activityStatus').textContent = '(Sensor disconnected)';
            
            const aiInsight = document.getElementById('aiInsight');
            aiInsight.textContent = "EmotiBit sensor disconnected. Turn on your sensor to resume real-time monitoring.";
            
            const dataQuality = document.getElementById('dataQuality');
            dataQuality.textContent = "Signal Quality: Sensor disconnected";
        }

        function showWaitingState() {
            document.getElementById('heartRate').textContent = '--';
            document.getElementById('hrStatus').textContent = '(Waiting for EmotiBit)';
            document.getElementById('hrvScore').textContent = '--';
            document.getElementById('hrvStatus').textContent = '(Waiting for EmotiBit)';
            document.getElementById('edaValue').textContent = '--';
            document.getElementById('edaStatus').textContent = '(Waiting for EmotiBit)';
            document.getElementById('activityLevel').textContent = '--';
            document.getElementById('activityStatus').textContent = '(Waiting for EmotiBit)';
        }

        function addRealDataToStream(data) {
            const timestamp = new Date().toLocaleTimeString();
            const dataStream = document.getElementById('dataStream');
            
            let statusText = '';
            if (data.connection_status === 'disconnected') {
                statusText = 'SENSOR DISCONNECTED - Turn on EmotiBit to resume monitoring';
            } else if (data.packets_received === 0) {
                statusText = 'No EmotiBit data - Turn on sensor and configure UDP to localhost:3000';
            } else {
                const hr = data.heart_rate || '--';
                const hrv = data.hrv_rmssd || '--';
                const eda = data.eda_tonic ? data.eda_tonic.toFixed(3) : '--';
                const activity = data.activity_level ? data.activity_level.toFixed(3) : '--';
                statusText = `REAL DATA: HR: ${hr} BPM | HRV: ${hrv} ms | EDA: ${eda} ŒºS | Activity: ${activity} | Packets: ${data.packets_received}`;
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-data">${statusText}</span>
            `;
            
            dataStream.appendChild(logEntry);
            dataStream.scrollTop = dataStream.scrollHeight;
            
            while (dataStream.children.length > 50) {
                dataStream.removeChild(dataStream.firstChild);
            }
        }

        function updateAIWithRealData(data) {
            const hasRealData = data.packets_received > 0 && data.connection_status === 'connected';
            const aiInsight = document.getElementById('aiInsight');
            const dataQuality = document.getElementById('dataQuality');
            
            if (!hasRealData) {
                aiInsight.textContent = "No real EmotiBit data available. Turn on your sensor and ensure it's sending UDP data to localhost:3000.";
                dataQuality.textContent = "Signal Quality: No real sensor data detected";
                return;
            }
            
            const insights = [];
            
            if (data.heart_rate !== null) {
                if (data.heart_rate > 100) {
                    insights.push("Real data shows elevated heart rate. Consider relaxation techniques.");
                } else if (data.heart_rate < 60) {
                    insights.push("Real data shows low heart rate. This could indicate good fitness.");
                } else {
                    insights.push("Real heart rate data appears normal and healthy.");
                }
            }
            
            if (data.hrv_rmssd !== null) {
                if (data.hrv_rmssd < 20) {
                    insights.push("Real HRV data suggests possible stress or fatigue.");
                } else if (data.hrv_rmssd > 60) {
                    insights.push("Excellent real HRV levels detected from your EmotiBit sensor.");
                }
            }
            
            if (data.eda_tonic !== null && data.eda_tonic > 1.0) {
                insights.push("Real skin conductance data shows elevated arousal levels.");
            }
            
            if (insights.length === 0) {
                insights.push("Real sensor data from EmotiBit appears normal. All physiological indicators are stable.");
            }
            
            aiInsight.textContent = insights.join(' ');
            
            if (data.heart_rate && data.hrv_rmssd) {
                dataQuality.textContent = `Signal Quality: Excellent Real Data (${data.heart_rate} BPM, ${data.hrv_rmssd} ms HRV) - ${data.packets_received} packets`;
            } else {
                dataQuality.textContent = `Signal Quality: Partial Real Data - ${data.packets_received} packets received`;
            }
        }

        function getHeartRateStatus(hr) {
            if (hr < 60) return 'Low';
            if (hr > 100) return 'High';
            return 'Normal';
        }

        function getHRVStatus(hrv) {
            if (hrv < 20) return 'Low';
            if (hrv > 60) return 'High';
            return 'Normal';
        }

        function getEDAStatus(eda) {
            if (eda < 0.1) return 'Very Low';
            if (eda > 2.0) return 'High';
            return 'Normal';
        }

        function getActivityStatus(activity) {
            if (activity < 0.05) return 'Resting';
            if (activity < 0.2) return 'Light';
            if (activity < 0.5) return 'Moderate';
            return 'Active';
        }

        function reconnectToBridge() {
            addLogEntry('Attempting to reconnect to bridge server...');
            fetchRealData();
        }

        function openBridgeStatus() {
            window.open('http://localhost:8080/status', '_blank');
        }

        function requestAIAnalysis() {
            if (realDataBuffer.length < 5) {
                alert('Need more real EmotiBit data for analysis. Please ensure your sensor is connected and sending data.');
                return;
            }
            
            const recentData = realDataBuffer.slice(-10);
            const hasRealHR = recentData.some(d => d.heart_rate !== null);
            
            if (!hasRealHR) {
                alert('No real heart rate data available. Check your EmotiBit connection and sensor placement.');
                return;
            }
            
            const avgHR = recentData.filter(d => d.heart_rate !== null)
                                   .reduce((sum, d) => sum + d.heart_rate, 0) / 
                          recentData.filter(d => d.heart_rate !== null).length;
            
            const analysis = `
üìä Real EmotiBit Data Analysis:

üíì Heart Rate: ${avgHR.toFixed(1)} BPM (from real PPG sensor)
ü´Ä Data Source: Actual EmotiBit hardware
üì° Packets Received: ${recentData[recentData.length-1].packets_received}
‚è±Ô∏è Analysis Window: Last ${recentData.length} real sensor readings

üéØ Real Data Insights:
- Your actual physiological state shows ${avgHR > 90 ? 'elevated' : avgHR < 70 ? 'calm' : 'normal'} heart rate
- EmotiBit sensor is providing high-quality real-time data
- This analysis is based on your actual body's signals, not simulated data

Data Quality: Real sensor data from your EmotiBit device
            `;
            
            alert(analysis);
        }

        function exportRealData() {
            if (realDataBuffer.length === 0) {
                alert('No real data to export. Please ensure EmotiBit is connected and sending data.');
                return;
            }
            
            let csvContent = "timestamp,heart_rate,hrv_rmssd,eda_tonic,activity_level,packets_received,data_source\n";
            
            realDataBuffer.forEach(data => {
                const row = [
                    new Date(data.timestamp * 1000).toISOString(),
                    data.heart_rate || '',
                    data.hrv_rmssd || '',
                    data.eda_tonic || '',
                    data.activity_level || '',
                    data.packets_received,
                    'real_emotibit_sensor'
                ].join(',');
                csvContent += row + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cardioguard_real_data_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert(`Exported ${realDataBuffer.length} real data points from EmotiBit sensor.`);
        }

        function clearDataStream() {
            document.getElementById('dataStream').innerHTML = `
                <div class="log-entry">
                    <span class="log-timestamp">[${new Date().toLocaleTimeString()}]</span>
                    <span class="log-data">Data stream cleared - Waiting for real EmotiBit data</span>
                </div>
            `;
        }

        function addLogEntry(message) {
            const timestamp = new Date().toLocaleTimeString();
            const dataStream = document.getElementById('dataStream');
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-data">${message}</span>
            `;
            
            dataStream.appendChild(logEntry);
            dataStream.scrollTop = dataStream.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('CardioGuard AI started - Real data only mode');
            addLogEntry('Connecting to HTTP bridge server...');
            
            startDataPolling();
            
            console.log('CardioGuard AI - HTTP Polling Version');
            console.log('Fetching real EmotiBit data from http://localhost:8080/data');
            console.log('No simulated data - requires actual sensor');
        });

        window.addEventListener('beforeunload', function() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    </script>
</body>
</html>