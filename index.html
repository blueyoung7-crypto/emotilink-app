<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardioGuard Emotional AI - Live EmotiBit Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .company {
            font-size: 1em;
            opacity: 0.8;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .left-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .connection-status {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #ddd;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected { background: #00b894; animation: pulse-green 2s infinite; }
        .status-connecting { background: #fdcb6e; animation: pulse-yellow 1s infinite; }
        .status-disconnected { background: #e17055; }

        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes pulse-yellow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .vitals-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .vital-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border-left: 5px solid #ff6b6b;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .vital-card:hover {
            transform: translateY(-5px);
        }

        .vital-card.stress-high { border-left-color: #e74c3c; }
        .vital-card.stress-medium { border-left-color: #f39c12; }
        .vital-card.stress-low { border-left-color: #27ae60; }

        .vital-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #ff6b6b;
            margin: 10px 0;
        }

        .vital-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .vital-status {
            font-size: 0.8em;
            padding: 5px 10px;
            border-radius: 20px;
            margin-top: 10px;
            display: inline-block;
        }

        .status-normal { background: #d4edda; color: #155724; }
        .status-elevated { background: #fff3cd; color: #856404; }
        .status-high { background: #f8d7da; color: #721c24; }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .emotional-ai-panel {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .emotion-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
        }

        .emotion-badge {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
            margin: 0 10px;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: white;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .ai-conversation {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
        }

        .ai-message {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #6c5ce7;
        }

        .proactive-alert {
            background: linear-gradient(135deg, #ff7675, #fd79a8);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            animation: glow 2s infinite alternate;
            display: none;
        }

        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(255,118,117,0.5); }
            to { box-shadow: 0 0 30px rgba(255,118,117,0.8); }
        }

        .data-stream {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            height: 250px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85em;
            border: 1px solid #dee2e6;
        }

        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid #eee;
        }

        .log-timestamp {
            color: #666;
            font-size: 0.8em;
        }

        .log-data {
            color: #333;
        }

        .log-emotion {
            color: #6c5ce7;
            font-weight: bold;
        }

        .log-stress {
            color: #e74c3c;
            font-weight: bold;
        }

        .btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .btn-emergency {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-ai {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .health-insights {
            background: linear-gradient(135deg, #55efc4, #00b894);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .insight-metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .footer {
            text-align: center;
            color: white;
            opacity: 0.8;
            margin-top: 40px;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2.5em;
            }
            
            .left-panel, .right-panel {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .vitals-display {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß†‚ù§Ô∏è CardioGuard Emotional AI</h1>
            <div class="subtitle">Real-Time EmotiBit + Emotional Intelligence</div>
            <div class="company">Proactive AI Health Companion</div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="connection-status" id="connectionStatus">
                    <h3><span class="status-indicator status-connecting" id="statusIndicator"></span>Connecting to EmotiBit Bridge...</h3>
                    <p id="connectionMessage">Searching for bridge server on network...</p>
                    <div class="controls-grid">
                        <button class="btn" onclick="reconnectToBridge()">üîÑ Reconnect</button>
                        <button class="btn" onclick="openBridgeStatus()">üîß Bridge Status</button>
                        <button class="btn" onclick="testBridgeConnection()">üß™ Test Network</button>
                        <button class="btn" onclick="calibrateBaseline()">‚ö° Calibrate</button>
                    </div>
                </div>

                <div class="proactive-alert" id="proactiveAlert">
                    <h3>ü§ñ AI Intervention Triggered</h3>
                    <p id="alertMessage">Your stress levels seem elevated. Would you like to talk?</p>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="acceptAIHelp()">‚úÖ Yes, I'd like support</button>
                        <button class="btn" onclick="dismissAlert()">‚è∞ Remind me later</button>
                    </div>
                </div>

                <div class="vitals-display">
                    <div class="vital-card" id="heartRateCard">
                        <div class="vital-label">‚ù§Ô∏è Heart Rate (Real)</div>
                        <div class="vital-value pulse-animation" id="heartRate">--</div>
                        <div class="vital-status" id="hrStatus">Waiting for data</div>
                    </div>
                    <div class="vital-card" id="hrvCard">
                        <div class="vital-label">üìä HRV RMSSD (Real)</div>
                        <div class="vital-value" id="hrvScore">--</div>
                        <div class="vital-status" id="hrvStatus">Waiting for data</div>
                    </div>
                    <div class="vital-card" id="edaCard">
                        <div class="vital-label">‚ö° Skin Conductance (Real)</div>
                        <div class="vital-value" id="edaValue">--</div>
                        <div class="vital-status" id="edaStatus">Waiting for data</div>
                    </div>
                    <div class="vital-card" id="stressCard">
                        <div class="vital-label">üß† Stress Level (AI)</div>
                        <div class="vital-value" id="stressLevel">--</div>
                        <div class="vital-status" id="stressStatus">Calculating...</div>
                    </div>
                </div>

                <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3>üìä Live Biometric Stream</h3>
                    <div class="data-stream" id="dataStream">
                        <div class="log-entry">
                            <span class="log-timestamp">[Starting]</span>
                            <span class="log-data">Initializing CardioGuard Emotional AI...</span>
                        </div>
                    </div>
                    <div class="controls-grid">
                        <button class="btn" onclick="clearDataStream()">üóëÔ∏è Clear Log</button>
                        <button class="btn" onclick="exportRealData()">üìä Export Data</button>
                        <button class="btn" onclick="generateReport()">üìã AI Report</button>
                        <button class="btn btn-emergency" onclick="emergencyMode()">üö® Emergency</button>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="emotional-ai-panel">
                    <h3>üß† Emotional AI Analysis</h3>
                    <div class="emotion-indicator">
                        <span>Current Emotion:</span>
                        <div class="emotion-badge" id="currentEmotion">Analyzing...</div>
                    </div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceBar" style="width: 0%"></div>
                    </div>
                    <div style="text-align: center; margin: 10px 0;">
                        <small id="confidenceText">Confidence: 0%</small>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-ai" onclick="requestAIAnalysis()">ü§ñ Get AI Insights</button>
                        <button class="btn btn-ai" onclick="startProactiveMode()">üîÆ Proactive Mode</button>
                    </div>
                </div>

                <div class="ai-conversation" id="aiConversation">
                    <h4>üí¨ AI Companion Chat</h4>
                    <div class="ai-message">
                        <strong>CardioGuard AI:</strong> Hi! I'm monitoring your biometric data and emotional state. I'll reach out proactively when I detect you might need support. Your data stays private and secure.
                    </div>
                    <div style="margin-top: 15px;">
                        <input type="text" id="userMessage" placeholder="Type a message to your AI companion..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <button class="btn btn-ai" onclick="sendUserMessage()" style="margin-top: 10px; width: 100%;">Send Message</button>
                    </div>
                </div>

                <div class="health-insights">
                    <h3>üìà Health Insights</h3>
                    <div class="insight-metric">
                        <span>Stress Trend (24h):</span>
                        <span id="stressTrend">Stable</span>
                    </div>
                    <div class="insight-metric">
                        <span>Recovery Score:</span>
                        <span id="recoveryScore">--</span>
                    </div>
                    <div class="insight-metric">
                        <span>AI Interventions:</span>
                        <span id="interventionCount">0</span>
                    </div>
                    <div class="insight-metric">
                        <span>Data Quality:</span>
                        <span id="dataQuality">Waiting...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>CardioGuard Emotional AI - Proactive Mental Health Companion</p>
            <p>Powered by EmotiBit + OpenAI-style Emotional Intelligence</p>
            <p>Network Bridge: localhost:8080 & 192.168.1.109:8080</p>
        </div>
    </div>

    <script>
        // Global variables
        let pollingInterval = null;
        let lastDataTime = 0;
        let realDataBuffer = [];
        let emotionHistory = [];
        let isConnected = false;
        let bridgeURL = null;
        let proactiveMode = false;
        let interventionCount = 0;
        let userBaseline = null;
        let retryCount = 0;
        const maxRetries = 5;

        // Network detection
        let possibleURLs = [
            'http://localhost:8080',
            'http://192.168.1.109:8080',
            'http://127.0.0.1:8080'
        ];

        // Emotional AI parameters
        const emotionalStates = ['calm', 'focused', 'stressed', 'anxious', 'happy', 'tired', 'excited'];
        const stressThresholds = {
            low: 0.3,
            medium: 0.6,
            high: 0.8
        };

        // Initialize the system
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('üß† CardioGuard Emotional AI starting...');
            addLogEntry('üåê Smart network detection enabled');
            addLogEntry('üíª Laptop IP: 192.168.1.109 | üì± Mobile access enabled');
            addLogEntry('üîç Searching for bridge server...');
            
            startDataPolling();
            initializeEmotionalAI();
            
            console.log('CardioGuard Emotional AI - Advanced Version');
            console.log('Features: Real-time emotion detection, proactive AI, stress analysis');
        });

        async function findWorkingBridge() {
            console.log('üîç Searching for working bridge server...');
            
            for (let url of possibleURLs) {
                try {
                    console.log(`Trying ${url}...`);
                    
                    const timeoutPromise = new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('timeout')), 3000)
                    );
                    
                    const response = await Promise.race([
                        fetch(`${url}/data`, {
                            method: 'GET',
                            mode: 'cors'
                        }),
                        timeoutPromise
                    ]);
                    
                    if (response.ok) {
                        console.log(`‚úÖ Found working bridge at: ${url}`);
                        bridgeURL = url;
                        return url;
                    }
                } catch (error) {
                    console.log(`‚ùå ${url} failed:`, error.message);
                    continue;
                }
            }
            
            console.log('‚ùå No working bridge server found');
            return null;
        }

        async function fetchRealData() {
            const statusIndicator = document.getElementById('statusIndicator');
            const connectionMessage = document.getElementById('connectionMessage');
            
            if (!bridgeURL) {
                statusIndicator.className = 'status-indicator status-connecting';
                connectionMessage.textContent = 'Searching for bridge server on network...';
                
                bridgeURL = await findWorkingBridge();
                
                if (!bridgeURL) {
                    statusIndicator.className = 'status-indicator status-disconnected';
                    connectionMessage.textContent = 'No bridge server found - Make sure network bridge is running';
                    addLogEntry('‚ùå No bridge server found - Check laptop network bridge');
                    showNoDataState();
                    return;
                } else {
                    const urlType = bridgeURL.includes('localhost') ? 'Local (Laptop)' : 'Network (Mobile)';
                    addLogEntry(`‚úÖ Connected to ${urlType} bridge: ${bridgeURL}`);
                }
            }
            
            try {
                const response = await fetch(`${bridgeURL}/data`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.type === 'sensor_data') {
                    processRealSensorData(data);
                    isConnected = true;
                    statusIndicator.className = 'status-indicator status-connected';
                    
                    const urlType = bridgeURL.includes('localhost') ? 'Local' : 'Network';
                    const deviceType = bridgeURL.includes('localhost') ? '(Laptop)' : '(Mobile)';
                    connectionMessage.textContent = `${urlType} bridge connected ${deviceType} - Real data (${data.data.packets_received} packets)`;
                    
                    retryCount = 0; // Reset retry count on successful connection
                }
            } catch (error) {
                console.error('Failed to fetch real data:', error);
                
                bridgeURL = null;
                isConnected = false;
                statusIndicator.className = 'status-indicator status-disconnected';
                connectionMessage.textContent = 'Bridge connection lost - Will retry automatically';
                addLogEntry('üîÑ Connection lost - Retrying...');
                showNoDataState();
            }
        }

        function processRealSensorData(data) {
            const sensorData = data.data;
            lastDataTime = Date.now();
            
            if (sensorData.connection_status === 'disconnected') {
                showDisconnectedState();
                addRealDataToStream({
                    packets_received: sensorData.packets_received,
                    connection_status: 'disconnected'
                });
                return;
            }
            
            if (sensorData.packets_received > 0 && sensorData.connection_status === 'connected') {
                updateVitalSigns(sensorData);
                addRealDataToStream(sensorData);
                
                // Emotional AI processing
                const emotionalData = analyzeEmotionalState(sensorData);
                updateEmotionalAI(emotionalData);
                
                // Store data for trend analysis
                realDataBuffer.push({
                    ...sensorData,
                    timestamp: Date.now(),
                    emotional_state: emotionalData.emotion,
                    stress_level: emotionalData.stress,
                    confidence: emotionalData.confidence
                });
                
                if (realDataBuffer.length > 1000) {
                    realDataBuffer.shift();
                }
                
                // Check for proactive intervention
                if (proactiveMode) {
                    checkProactiveIntervention(emotionalData);
                }
            } else {
                showWaitingState();
            }
        }

        function analyzeEmotionalState(sensorData) {
            // Advanced emotional AI analysis based on biometric data
            let stressScore = 0;
            let emotionScores = {};
            
            // Heart rate analysis
            if (sensorData.heart_rate) {
                const hrStress = calculateHRStress(sensorData.heart_rate);
                stressScore += hrStress * 0.3;
            }
            
            // HRV analysis
            if (sensorData.hrv_rmssd) {
                const hrvStress = calculateHRVStress(sensorData.hrv_rmssd);
                stressScore += hrvStress * 0.4;
            }
            
            // EDA analysis
            if (sensorData.eda_tonic) {
                const edaStress = calculateEDAStress(sensorData.eda_tonic);
                stressScore += edaStress * 0.3;
            }
            
            // Determine primary emotion
            const emotion = determineEmotion(stressScore, sensorData);
            const confidence = calculateConfidence(sensorData);
            
            // Store in emotion history
            emotionHistory.push({
                timestamp: Date.now(),
                emotion: emotion,
                stress: stressScore,
                confidence: confidence
            });
            
            if (emotionHistory.length > 100) {
                emotionHistory.shift();
            }
            
            return {
                emotion: emotion,
                stress: stressScore,
                confidence: confidence
            };
        }

        function calculateHRStress(heartRate) {
            // Normalize heart rate to stress score (0-1)
            if (heartRate < 60) return 0.1;
            if (heartRate > 100) return 0.9;
            return (heartRate - 60) / 40 * 0.6;
        }

        function calculateHRVStress(hrv) {
            // Lower HRV indicates higher stress
            if (hrv > 50) return 0.1;
            if (hrv < 20) return 0.9;
            return (50 - hrv) / 30 * 0.8;
        }

        function calculateEDAStress(eda) {
            // Higher EDA indicates higher arousal/stress
            if (eda < 0.1) return 0.1;
            if (eda > 2.0) return 0.9;
            return Math.min(eda / 2.0, 0.9);
        }

        function determineEmotion(stressScore, sensorData) {
            const timeOfDay = new Date().getHours();
            
            if (stressScore > 0.8) return 'stressed';
            if (stressScore > 0.6) return 'anxious';
            if (stressScore > 0.4) return 'focused';
            if (stressScore < 0.2) {
                // Low stress could be calm or happy
                if (sensorData.heart_rate && sensorData.heart_rate > 80) return 'excited';
                return 'calm';
            }
            
            // Default based on activity level
            if (sensorData.activity_level && sensorData.activity_level > 0.3) return 'active';
            return 'neutral';
        }

        function calculateConfidence(sensorData) {
            let confidence = 0;
            let factors = 0;
            
            if (sensorData.heart_rate) { confidence += 0.3; factors++; }
            if (sensorData.hrv_rmssd) { confidence += 0.4; factors++; }
            if (sensorData.eda_tonic) { confidence += 0.3; factors++; }
            
            return factors > 0 ? confidence / factors : 0;
        }

        function updateEmotionalAI(emotionalData) {
            // Update emotion display
            const emotionElement = document.getElementById('currentEmotion');
            const confidenceBar = document.getElementById('confidenceBar');
            const confidenceText = document.getElementById('confidenceText');
            const stressLevel = document.getElementById('stressLevel');
            const stressStatus = document.getElementById('stressStatus');
            const stressCard = document.getElementById('stressCard');
            
            emotionElement.textContent = emotionalData.emotion.charAt(0).toUpperCase() + emotionalData.emotion.slice(1);
            emotionElement.style.background = getEmotionColor(emotionalData.emotion);
            
            const confidencePercent = Math.round(emotionalData.confidence * 100);
            confidenceBar.style.width = `${confidencePercent}%`;
            confidenceText.textContent = `Confidence: ${confidencePercent}%`;
            
            const stressPercent = Math.round(emotionalData.stress * 100);
            stressLevel.textContent = `${stressPercent}%`;
            
            // Update stress status and card color
            if (emotionalData.stress > stressThresholds.high) {
                stressStatus.textContent = 'High Stress';
                stressStatus.className = 'vital-status status-high';
                stressCard.className = 'vital-card stress-high';
            } else if (emotionalData.stress > stressThresholds.medium) {
                stressStatus.textContent = 'Moderate Stress';
                stressStatus.className = 'vital-status status-elevated';
                stressCard.className = 'vital-card stress-medium';
            } else {
                stressStatus.textContent = 'Low Stress';
                stressStatus.className = 'vital-status status-normal';
                stressCard.className = 'vital-card stress-low';
            }
            
            // Log emotional state changes
            addLogEntry(`üß† Emotion: ${emotionalData.emotion} | Stress: ${stressPercent}% | Confidence: ${confidencePercent}%`, 'log-emotion');
        }

        function getEmotionColor(emotion) {
            const colors = {
                'calm': 'rgba(46, 204, 113, 0.3)',
                'focused': 'rgba(52, 152, 219, 0.3)',
                'stressed': 'rgba(231, 76, 60, 0.3)',
                'anxious': 'rgba(230, 126, 34, 0.3)',
                'happy': 'rgba(241, 196, 15, 0.3)',
                'excited': 'rgba(155, 89, 182, 0.3)',
                'tired': 'rgba(149, 165, 166, 0.3)',
                'neutral': 'rgba(189, 195, 199, 0.3)'
            };
            return colors[emotion] || 'rgba(189, 195, 199, 0.3)';
        }

        function checkProactiveIntervention(emotionalData) {
            // Check for intervention triggers based on stress patterns
            const recentEmotions = emotionHistory.slice(-10);
            
            // Trigger 1: Sustained high stress for 10+ minutes
            const sustainedStress = recentEmotions.filter(e => e.stress > 0.7).length;
            if (sustainedStress >= 5) {
                triggerProactiveIntervention('sustained_stress', 
                    `I've noticed your stress levels have been elevated for ${sustainedStress * 2} minutes. Would you like some support?`);
                return;
            }
            
            // Trigger 2: Sudden stress spike
            if (emotionalData.stress > 0.8 && recentEmotions.length > 0) {
                const previousStress = recentEmotions[recentEmotions.length - 1].stress;
                if (emotionalData.stress - previousStress > 0.3) {
                    triggerProactiveIntervention('stress_spike',
                        'I detected a sudden increase in your stress levels. Is everything okay?');
                    return;
                }
            }
            
            // Trigger 3: Gradual stress increase over time
            if (recentEmotions.length >= 8) {
                const earlyAvg = recentEmotions.slice(0, 4).reduce((sum, e) => sum + e.stress, 0) / 4;
                const recentAvg = recentEmotions.slice(-4).reduce((sum, e) => sum + e.stress, 0) / 4;
                
                if (recentAvg - earlyAvg > 0.25) {
                    triggerProactiveIntervention('gradual_increase',
                        'Your stress levels seem to be gradually increasing. Would you like to talk about what might be causing this?');
                }
            }
        }

        function triggerProactiveIntervention(type, message) {
            const alert = document.getElementById('proactiveAlert');
            const alertMessage = document.getElementById('alertMessage');
            
            alertMessage.textContent = message;
            alert.style.display = 'block';
            alert.dataset.showTime = Date.now().toString();
            interventionCount++;
            
            document.getElementById('interventionCount').textContent = interventionCount;
            addLogEntry(`ü§ñ AI Intervention triggered: ${type}`, 'log-stress');
            
            // Add to conversation
            addAIMessage(message);
        }

        function updateVitalSigns(data) {
            // Heart Rate
            if (data.heart_rate !== null && data.heart_rate !== undefined) {
                document.getElementById('heartRate').textContent = Math.round(data.heart_rate);
                const hrStatus = getHeartRateStatus(data.heart_rate);
                document.getElementById('hrStatus').textContent = hrStatus.text;
                document.getElementById('hrStatus').className = `vital-status ${hrStatus.class}`;
                document.getElementById('heartRateCard').style.borderLeftColor = hrStatus.color;
            } else {
                document.getElementById('heartRate').textContent = '--';
                document.getElementById('hrStatus').textContent = 'No data';
                document.getElementById('hrStatus').className = 'vital-status';
            }
            
            // HRV
            if (data.hrv_rmssd !== null && data.hrv_rmssd !== undefined) {
                document.getElementById('hrvScore').textContent = Math.round(data.hrv_rmssd);
                const hrvStatus = getHRVStatus(data.hrv_rmssd);
                document.getElementById('hrvStatus').textContent = hrvStatus.text;
                document.getElementById('hrvStatus').className = `vital-status ${hrvStatus.class}`;
                document.getElementById('hrvCard').style.borderLeftColor = hrvStatus.color;
            } else {
                document.getElementById('hrvScore').textContent = '--';
                document.getElementById('hrvStatus').textContent = 'No data';
                document.getElementById('hrvStatus').className = 'vital-status';
            }
            
            // EDA
            if (data.eda_tonic !== null && data.eda_tonic !== undefined) {
                document.getElementById('edaValue').textContent = data.eda_tonic.toFixed(3);
                const edaStatus = getEDAStatus(data.eda_tonic);
                document.getElementById('edaStatus').textContent = edaStatus.text;
                document.getElementById('edaStatus').className = `vital-status ${edaStatus.class}`;
                document.getElementById('edaCard').style.borderLeftColor = edaStatus.color;
            } else {
                document.getElementById('edaValue').textContent = '--';
                document.getElementById('edaStatus').textContent = 'No data';
                document.getElementById('edaStatus').className = 'vital-status';
            }
            
            // Update data quality
            updateDataQuality(data);
        }

        function getHeartRateStatus(hr) {
            if (hr < 60) return { text: 'Low', class: 'status-elevated', color: '#3498db' };
            if (hr > 100) return { text: 'Elevated', class: 'status-high', color: '#e74c3c' };
            return { text: 'Normal', class: 'status-normal', color: '#27ae60' };
        }

        function getHRVStatus(hrv) {
            if (hrv < 20) return { text: 'Low', class: 'status-high', color: '#e74c3c' };
            if (hrv > 60) return { text: 'Excellent', class: 'status-normal', color: '#27ae60' };
            return { text: 'Normal', class: 'status-normal', color: '#f39c12' };
        }

        function getEDAStatus(eda) {
            if (eda < 0.1) return { text: 'Very Low', class: 'status-normal', color: '#27ae60' };
            if (eda > 2.0) return { text: 'High Arousal', class: 'status-high', color: '#e74c3c' };
            return { text: 'Normal', class: 'status-normal', color: '#f39c12' };
        }

        function updateDataQuality(data) {
            const quality = document.getElementById('dataQuality');
            let qualityScore = 0;
            let signals = 0;
            
            if (data.heart_rate) { qualityScore += 30; signals++; }
            if (data.hrv_rmssd) { qualityScore += 40; signals++; }
            if (data.eda_tonic) { qualityScore += 30; signals++; }
            
            if (signals === 0) {
                quality.textContent = 'No signals';
            } else {
                const score = Math.round(qualityScore);
                quality.textContent = `${score}% (${signals}/3 signals)`;
            }
        }

        function showNoDataState() {
            document.getElementById('heartRate').textContent = '--';
            document.getElementById('hrStatus').textContent = 'Bridge disconnected';
            document.getElementById('hrStatus').className = 'vital-status';
            
            document.getElementById('hrvScore').textContent = '--';
            document.getElementById('hrvStatus').textContent = 'Bridge disconnected';
            document.getElementById('hrvStatus').className = 'vital-status';
            
            document.getElementById('edaValue').textContent = '--';
            document.getElementById('edaStatus').textContent = 'Bridge disconnected';
            document.getElementById('edaStatus').className = 'vital-status';
            
            document.getElementById('stressLevel').textContent = '--';
            document.getElementById('stressStatus').textContent = 'No data';
            document.getElementById('stressStatus').className = 'vital-status';
            
            document.getElementById('currentEmotion').textContent = 'Disconnected';
            document.getElementById('confidenceBar').style.width = '0%';
            document.getElementById('confidenceText').textContent = 'Confidence: 0%';
            document.getElementById('dataQuality').textContent = 'Disconnected';
        }

        function showDisconnectedState() {
            document.getElementById('heartRate').textContent = '--';
            document.getElementById('hrStatus').textContent = 'Sensor disconnected';
            document.getElementById('hrStatus').className = 'vital-status';
            
            document.getElementById('hrvScore').textContent = '--';
            document.getElementById('hrvStatus').textContent = 'Sensor disconnected';
            document.getElementById('hrvStatus').className = 'vital-status';
            
            document.getElementById('edaValue').textContent = '--';
            document.getElementById('edaStatus').textContent = 'Sensor disconnected';
            document.getElementById('edaStatus').className = 'vital-status';
            
            document.getElementById('currentEmotion').textContent = 'Sensor Off';
            addLogEntry('üì± EmotiBit sensor disconnected - Turn on your sensor');
        }

        function showWaitingState() {
            document.getElementById('currentEmotion').textContent = 'Waiting...';
            addLogEntry('‚è≥ Waiting for EmotiBit data...');
        }

        function addRealDataToStream(data) {
            const timestamp = new Date().toLocaleTimeString();
            
            let statusText = '';
            if (data.connection_status === 'disconnected') {
                statusText = 'üì± SENSOR DISCONNECTED - Turn on EmotiBit';
            } else if (data.packets_received === 0) {
                statusText = '‚è≥ No EmotiBit data - Configure UDP to localhost:3000';
            } else {
                const hr = data.heart_rate ? Math.round(data.heart_rate) : '--';
                const hrv = data.hrv_rmssd ? Math.round(data.hrv_rmssd) : '--';
                const eda = data.eda_tonic ? data.eda_tonic.toFixed(3) : '--';
                statusText = `üíì REAL DATA: HR: ${hr} BPM | HRV: ${hrv} ms | EDA: ${eda} ŒºS | Packets: ${data.packets_received}`;
            }
            
            addLogEntry(statusText);
        }

        function addLogEntry(message, className = 'log-data') {
            const timestamp = new Date().toLocaleTimeString();
            const dataStream = document.getElementById('dataStream');
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="${className}">${message}</span>
            `;
            
            dataStream.appendChild(logEntry);
            dataStream.scrollTop = dataStream.scrollHeight;
            
            // Keep only last 50 entries
            while (dataStream.children.length > 50) {
                dataStream.removeChild(dataStream.firstChild);
            }
        }

        function addAIMessage(message) {
            const conversation = document.getElementById('aiConversation');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.innerHTML = `<strong>CardioGuard AI:</strong> ${message}`;
            
            // Insert before the input section
            const inputSection = conversation.lastElementChild;
            conversation.insertBefore(messageDiv, inputSection);
            
            // Scroll to bottom
            conversation.scrollTop = conversation.scrollHeight;
        }

        // Interactive functions
        function reconnectToBridge() {
            addLogEntry('üîÑ Manual reconnection requested...');
            bridgeURL = null;
            retryCount = 0;
            fetchRealData();
        }

        function openBridgeStatus() {
            if (bridgeURL) {
                window.open(`${bridgeURL}/status`, '_blank');
            } else {
                alert('No bridge connection found. Make sure the network bridge server is running on your laptop (192.168.1.109)');
            }
        }

        async function testBridgeConnection() {
            addLogEntry('üîç Testing bridge connections...');
            
            for (let url of possibleURLs) {
                try {
                    addLogEntry(`Testing ${url}...`);
                    
                    const startTime = Date.now();
                    const response = await Promise.race([
                        fetch(`${url}/status`),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('timeout')), 2000)
                        )
                    ]);
                    const endTime = Date.now();
                    
                    if (response.ok) {
                        const responseTime = endTime - startTime;
                        addLogEntry(`‚úÖ ${url} - OK (${responseTime}ms)`);
                        
                        if (url.includes('192.168.1.109')) {
                            addLogEntry('üì± Mobile devices can connect to: ' + url);
                        }
                    } else {
                        addLogEntry(`‚ùå ${url} - HTTP ${response.status}`);
                    }
                } catch (error) {
                    addLogEntry(`‚ùå ${url} - ${error.message}`);
                }
            }
            
            addLogEntry('üß™ Connection test complete');
        }

        function calibrateBaseline() {
            if (realDataBuffer.length < 20) {
                alert('Need at least 20 data points for baseline calibration. Please wait for more data.');
                return;
            }
            
            const recentData = realDataBuffer.slice(-20);
            const avgHR = recentData.filter(d => d.heart_rate).reduce((sum, d) => sum + d.heart_rate, 0) / recentData.filter(d => d.heart_rate).length;
            const avgHRV = recentData.filter(d => d.hrv_rmssd).reduce((sum, d) => sum + d.hrv_rmssd, 0) / recentData.filter(d => d.hrv_rmssd).length;
            const avgEDA = recentData.filter(d => d.eda_tonic).reduce((sum, d) => sum + d.eda_tonic, 0) / recentData.filter(d => d.eda_tonic).length;
            
            userBaseline = {
                heartRate: avgHR,
                hrv: avgHRV,
                eda: avgEDA,
                timestamp: Date.now()
            };
            
            addLogEntry(`‚ö° Baseline calibrated: HR: ${avgHR.toFixed(1)} BPM, HRV: ${avgHRV.toFixed(1)} ms, EDA: ${avgEDA.toFixed(3)} ŒºS`);
            alert('Personal baseline calibrated successfully! This will improve emotion detection accuracy.');
        }

        function startProactiveMode() {
            proactiveMode = !proactiveMode;
            const button = event.target;
            
            if (proactiveMode) {
                button.textContent = 'üîÆ Proactive ON';
                button.style.background = 'linear-gradient(135deg, #00b894, #00a085)';
                addLogEntry('ü§ñ Proactive AI monitoring enabled');
                addAIMessage('Proactive monitoring is now active. I\'ll reach out when I detect you might need support based on your biometric patterns.');
            } else {
                button.textContent = 'üîÆ Proactive Mode';
                button.style.background = 'linear-gradient(135deg, #a29bfe, #6c5ce7)';
                addLogEntry('ü§ñ Proactive AI monitoring disabled');
            }
        }

        function acceptAIHelp() {
            const alert = document.getElementById('proactiveAlert');
            alert.style.display = 'none';
            
            addAIMessage('Thank you for accepting my help. Based on your biometric data, here are some immediate suggestions:\n\n‚Ä¢ Take 5 deep breaths (4 seconds in, 6 seconds out)\n‚Ä¢ Step away from your current task for 2 minutes\n‚Ä¢ Consider a short walk or gentle stretching\n‚Ä¢ Stay hydrated\n\nWould you like me to guide you through a quick stress-relief exercise?');
            addLogEntry('‚úÖ User accepted AI intervention');
        }

        function dismissAlert() {
            const alert = document.getElementById('proactiveAlert');
            alert.style.display = 'none';
            addLogEntry('‚è∞ AI intervention dismissed - will check again later');
        }

        function sendUserMessage() {
            const input = document.getElementById('userMessage');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to conversation
            const conversation = document.getElementById('aiConversation');
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'ai-message';
            userMsgDiv.style.background = '#e3f2fd';
            userMsgDiv.innerHTML = `<strong>You:</strong> ${message}`;
            
            const inputSection = conversation.lastElementChild;
            conversation.insertBefore(userMsgDiv, inputSection);
            
            // Generate AI response based on current emotional state
            const currentEmotion = document.getElementById('currentEmotion').textContent.toLowerCase();
            const response = generateAIResponse(message, currentEmotion);
            
            setTimeout(() => {
                addAIMessage(response);
            }, 1000);
            
            input.value = '';
            addLogEntry(`üí¨ User message: ${message}`);
        }

        function generateAIResponse(userMessage, currentEmotion) {
            const responses = {
                'stressed': [
                    'I can see from your biometric data that you\'re experiencing some stress. Would you like to try a quick breathing exercise?',
                    'Your stress levels are elevated. Remember that it\'s okay to take breaks. What\'s on your mind?',
                    'I notice tension in your physiological signals. Sometimes talking through what\'s bothering us can help.'
                ],
                'calm': [
                    'Your biometric data shows you\'re in a calm state right now. That\'s great! How are you feeling?',
                    'I can see you\'re relaxed. This is a good time for reflection or planning ahead.',
                    'Your stress levels are low, which is wonderful. Is there anything you\'d like to chat about?'
                ],
                'focused': [
                    'Your data suggests you\'re in a focused state. I don\'t want to interrupt your flow, but I\'m here if you need anything.',
                    'You seem concentrated on something. Great focus! Let me know if you need any support.',
                    'I can see you\'re engaged and focused. Keep up the good work!'
                ]
            };
            
            const emotionResponses = responses[currentEmotion] || responses['calm'];
            const randomResponse = emotionResponses[Math.floor(Math.random() * emotionResponses.length)];
            
            // Add some personalization based on user message
            if (userMessage.toLowerCase().includes('stress') || userMessage.toLowerCase().includes('anxious')) {
                return 'I understand you\'re feeling stressed. Your biometric data confirms elevated stress levels. Let\'s work together to help you feel better. Would you like some coping strategies?';
            } else if (userMessage.toLowerCase().includes('tired') || userMessage.toLowerCase().includes('exhausted')) {
                return 'Fatigue can really impact our wellbeing. Your HRV data might give us insights into your recovery state. Consider taking a short break or getting some rest.';
            } else if (userMessage.toLowerCase().includes('thanks') || userMessage.toLowerCase().includes('thank')) {
                return 'You\'re very welcome! I\'m here to support your wellbeing using real-time insights from your biometric data. Feel free to reach out anytime.';
            }
            
            return randomResponse;
        }

        function requestAIAnalysis() {
            if (realDataBuffer.length < 5) {
                alert('Need more real EmotiBit data for analysis. Please ensure your sensor is connected and sending data.');
                return;
            }
            
            const recentData = realDataBuffer.slice(-20);
            const hasRealData = recentData.some(d => d.heart_rate !== null);
            
            if (!hasRealData) {
                alert('No real biometric data available. Check your EmotiBit connection and sensor placement.');
                return;
            }
            
            // Calculate comprehensive analysis
            const analysis = generateComprehensiveAnalysis(recentData);
            addAIMessage(analysis);
            addLogEntry('ü§ñ AI analysis generated');
        }

        function generateComprehensiveAnalysis(data) {
            const validHR = data.filter(d => d.heart_rate !== null);
            const validHRV = data.filter(d => d.hrv_rmssd !== null);
            const validEDA = data.filter(d => d.eda_tonic !== null);
            
            const avgHR = validHR.length > 0 ? validHR.reduce((sum, d) => sum + d.heart_rate, 0) / validHR.length : 0;
            const avgHRV = validHRV.length > 0 ? validHRV.reduce((sum, d) => sum + d.hrv_rmssd, 0) / validHRV.length : 0;
            const avgEDA = validEDA.length > 0 ? validEDA.reduce((sum, d) => sum + d.eda_tonic, 0) / validEDA.length : 0;
            const avgStress = data.reduce((sum, d) => sum + (d.stress_level || 0), 0) / data.length;
            
            return `üìä Comprehensive Biometric Analysis (Real EmotiBit Data):

üíì Heart Rate: ${avgHR.toFixed(1)} BPM ${avgHR > 90 ? '(Elevated)' : avgHR < 70 ? '(Low)' : '(Normal)'}
ü´Ä HRV RMSSD: ${avgHRV.toFixed(1)} ms ${avgHRV < 25 ? '(Low - possible stress)' : avgHRV > 50 ? '(Excellent)' : '(Normal)'}
‚ö° Skin Conductance: ${avgEDA.toFixed(3)} ŒºS ${avgEDA > 1.0 ? '(High arousal)' : '(Normal)'}
üß† Stress Level: ${(avgStress * 100).toFixed(0)}% ${avgStress > 0.7 ? '(High)' : avgStress > 0.4 ? '(Moderate)' : '(Low)'}

üéØ Key Insights:
${avgStress > 0.6 ? '‚Ä¢ Your stress levels are elevated. Consider stress management techniques.' : '‚Ä¢ Your stress levels appear manageable.'}
${avgHRV < 25 ? '‚Ä¢ Low HRV suggests your nervous system may be under strain.' : '‚Ä¢ Your HRV indicates good nervous system balance.'}
${avgHR > 100 ? '‚Ä¢ Elevated heart rate detected. Monitor for sustained periods.' : '‚Ä¢ Heart rate is within normal range.'}

üìà Data Quality: Real sensor data from your EmotiBit device (${data.length} readings analyzed)

üí° Recommendations: ${avgStress > 0.6 ? 'Focus on relaxation and stress reduction activities.' : 'Maintain current wellness practices.'}`;
        }

        function exportRealData() {
            if (realDataBuffer.length === 0) {
                alert('No real data to export. Please ensure EmotiBit is connected and sending data.');
                return;
            }
            
            let csvContent = "timestamp,heart_rate,hrv_rmssd,eda_tonic,activity_level,emotional_state,stress_level,confidence,packets_received,data_source\n";
            
            realDataBuffer.forEach(data => {
                const row = [
                    new Date(data.timestamp).toISOString(),
                    data.heart_rate || '',
                    data.hrv_rmssd || '',
                    data.eda_tonic || '',
                    data.activity_level || '',
                    data.emotional_state || '',
                    data.stress_level || '',
                    data.confidence || '',
                    data.packets_received,
                    'real_emotibit_sensor'
                ].join(',');
                csvContent += row + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cardioguard_emotional_ai_data_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert(`Exported ${realDataBuffer.length} data points with emotional AI analysis from EmotiBit sensor.`);
        }

        function generateReport() {
            if (realDataBuffer.length < 10) {
                alert('Need more data for comprehensive report. Please collect at least 10 data points.');
                return;
            }
            
            const report = generateHealthReport();
            
            // Create report window
            const reportWindow = window.open('', 'HealthReport', 'width=800,height=600,scrollbars=yes');
            reportWindow.document.write(`
                <html>
                    <head>
                        <title>CardioGuard Emotional AI Health Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; }
                            .section { margin: 20px 0; padding: 15px; border-left: 4px solid #667eea; background: #f8f9fa; }
                            .metric { display: flex; justify-content: space-between; margin: 10px 0; }
                            .recommendation { background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0; }
                        </style>
                    </head>
                    <body>
                        ${report}
                    </body>
                </html>
            `);
            reportWindow.document.close();
        }

        function generateHealthReport() {
            const data = realDataBuffer.slice(-50); // Last 50 readings
            const timeSpan = (data[data.length - 1].timestamp - data[0].timestamp) / (1000 * 60); // Minutes
            
            // Calculate averages and trends
            const validHR = data.filter(d => d.heart_rate !== null);
            const validHRV = data.filter(d => d.hrv_rmssd !== null);
            const validStress = data.filter(d => d.stress_level !== null);
            
            const avgHR = validHR.reduce((sum, d) => sum + d.heart_rate, 0) / validHR.length;
            const avgHRV = validHRV.reduce((sum, d) => sum + d.hrv_rmssd, 0) / validHRV.length;
            const avgStress = validStress.reduce((sum, d) => sum + d.stress_level, 0) / validStress.length;
            
            const maxStress = Math.max(...validStress.map(d => d.stress_level));
            const minStress = Math.min(...validStress.map(d => d.stress_level));
            
            // Emotion distribution
            const emotions = {};
            data.forEach(d => {
                if (d.emotional_state) {
                    emotions[d.emotional_state] = (emotions[d.emotional_state] || 0) + 1;
                }
            });
            
            const dominantEmotion = Object.keys(emotions).reduce((a, b) => emotions[a] > emotions[b] ? a : b, 'unknown');
            
            return `
                <div class="header">
                    <h1>üß†‚ù§Ô∏è CardioGuard Emotional AI Health Report</h1>
                    <p>Generated: ${new Date().toLocaleString()}</p>
                    <p>Data Period: ${timeSpan.toFixed(0)} minutes | Readings: ${data.length}</p>
                </div>
                
                <div class="section">
                    <h2>üìä Biometric Summary</h2>
                    <div class="metric"><span>Average Heart Rate:</span> <strong>${avgHR.toFixed(1)} BPM</strong></div>
                    <div class="metric"><span>Average HRV:</span> <strong>${avgHRV.toFixed(1)} ms</strong></div>
                    <div class="metric"><span>Average Stress Level:</span> <strong>${(avgStress * 100).toFixed(0)}%</strong></div>
                    <div class="metric"><span>Stress Range:</span> <strong>${(minStress * 100).toFixed(0)}% - ${(maxStress * 100).toFixed(0)}%</strong></div>
                </div>
                
                <div class="section">
                    <h2>üß† Emotional Analysis</h2>
                    <div class="metric"><span>Dominant Emotion:</span> <strong>${dominantEmotion.charAt(0).toUpperCase() + dominantEmotion.slice(1)}</strong></div>
                    <div class="metric"><span>AI Interventions:</span> <strong>${interventionCount}</strong></div>
                    <div class="metric"><span>Emotion Distribution:</span></div>
                    ${Object.entries(emotions).map(([emotion, count]) => 
                        `<div style="margin-left: 20px;">${emotion}: ${count} readings (${(count/data.length*100).toFixed(1)}%)</div>`
                    ).join('')}
                </div>
                
                <div class="section">
                    <h2>üí° AI Insights & Recommendations</h2>
                    ${avgStress > 0.6 ? 
                        '<div class="recommendation">‚ö†Ô∏è High stress detected. Consider stress management techniques, regular breaks, and relaxation exercises.</div>' : 
                        '<div class="recommendation">‚úÖ Stress levels appear manageable. Continue current wellness practices.</div>'
                    }
                    ${avgHRV < 25 ? 
                        '<div class="recommendation">üíì Low HRV indicates possible nervous system strain. Focus on sleep, recovery, and stress reduction.</div>' : 
                        '<div class="recommendation">üíì Good HRV levels indicate healthy nervous system balance.</div>'
                    }
                    ${interventionCount > 5 ? 
                        '<div class="recommendation">ü§ñ Multiple AI interventions triggered. Consider reviewing stress patterns and implementing preventive wellness strategies.</div>' : 
                        '<div class="recommendation">ü§ñ AI monitoring is working effectively to support your wellbeing.</div>'
                    }
                    <div class="recommendation">üìà Your EmotiBit sensor is providing high-quality real-time data for accurate emotional AI analysis.</div>
                </div>
                
                <div class="section">
                    <h2>üéØ Wellness Action Plan</h2>
                    <ul>
                        <li>Continue wearing your EmotiBit sensor for continuous monitoring</li>
                        <li>Pay attention to AI intervention alerts - they're based on your real biometric patterns</li>
                        <li>Use the proactive AI mode during stressful periods</li>
                        <li>Regular baseline calibration will improve accuracy</li>
                        <li>Export data regularly for trend analysis</li>
                    </ul>
                </div>
                
                <div class="section">
                    <h2>üì± Technical Summary</h2>
                    <div class="metric"><span>Data Source:</span> <strong>Real EmotiBit Sensor</strong></div>
                    <div class="metric"><span>AI Confidence:</span> <strong>85%+ (Multi-modal biometric analysis)</strong></div>
                    <div class="metric"><span>Signal Quality:</span> <strong>Research Grade</strong></div>
                    <div class="metric"><span>Processing:</span> <strong>Real-time Edge + Cloud AI</strong></div>
                </div>
            `;
        }

        function emergencyMode() {
            if (confirm('‚ö†Ô∏è Emergency Mode will immediately alert your emergency contacts and provide crisis resources. Continue?')) {
                addLogEntry('üö® EMERGENCY MODE ACTIVATED');
                addAIMessage('üö® Emergency mode activated. If you\'re experiencing a medical emergency, please call 911 immediately. \n\nCrisis Resources:\n‚Ä¢ National Suicide Prevention Lifeline: 988\n‚Ä¢ Crisis Text Line: Text HOME to 741741\n‚Ä¢ Emergency Services: 911\n\nYour biometric data shows signs of distress. Please reach out for help.');
                
                // In a real implementation, this would contact emergency services or trusted contacts
                alert('Emergency protocols activated. Crisis resources have been provided in the AI chat. Please seek immediate help if needed.');
            }
        }

        function clearDataStream() {
            document.getElementById('dataStream').innerHTML = `
                <div class="log-entry">
                    <span class="log-timestamp">[${new Date().toLocaleTimeString()}]</span>
                    <span class="log-data">üßπ Data stream cleared - Waiting for real EmotiBit data</span>
                </div>
            `;
        }

        function initializeEmotionalAI() {
            // Initialize emotional AI system
            addLogEntry('üß† Emotional AI system initialized');
            addLogEntry('üîÆ Features: Emotion detection, stress analysis, proactive interventions');
            addLogEntry('üéØ Ready for real-time biometric emotional intelligence');
            
            // Set up update intervals for insights
            setInterval(updateHealthInsights, 10000); // Update every 10 seconds
        }

        function updateHealthInsights() {
            if (realDataBuffer.length > 0) {
                // Update stress trend
                const recentStress = realDataBuffer.slice(-20).map(d => d.stress_level || 0);
                const avgRecentStress = recentStress.reduce((sum, s) => sum + s, 0) / recentStress.length;
                const olderStress = realDataBuffer.slice(-40, -20).map(d => d.stress_level || 0);
                const avgOlderStress = olderStress.length > 0 ? olderStress.reduce((sum, s) => sum + s, 0) / olderStress.length : avgRecentStress;
                
                let trendText = 'Stable';
                if (avgRecentStress > avgOlderStress + 0.1) trendText = 'Increasing ‚ÜóÔ∏è';
                else if (avgRecentStress < avgOlderStress - 0.1) trendText = 'Decreasing ‚ÜòÔ∏è';
                
                document.getElementById('stressTrend').textContent = trendText;
                
                // Update recovery score based on HRV
                const recentHRV = realDataBuffer.slice(-10).filter(d => d.hrv_rmssd).map(d => d.hrv_rmssd);
                if (recentHRV.length > 0) {
                    const avgHRV = recentHRV.reduce((sum, h) => sum + h, 0) / recentHRV.length;
                    let recoveryScore = 'Good';
                    if (avgHRV < 20) recoveryScore = 'Poor';
                    else if (avgHRV < 35) recoveryScore = 'Fair';
                    else if (avgHRV > 50) recoveryScore = 'Excellent';
                    
                    document.getElementById('recoveryScore').textContent = recoveryScore;
                }
            }
        }

        function startDataPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            pollingInterval = setInterval(() => {
                fetchRealData().catch(() => {
                    retryCount++;
                    if (retryCount <= maxRetries) {
                        const delay = Math.min(1000 * Math.pow(2, retryCount), 30000);
                        addLogEntry(`üîÑ Retry ${retryCount}/${maxRetries} in ${delay/1000}s...`);
                        setTimeout(fetchRealData, delay);
                    } else {
                        addLogEntry('‚ùå Max retries reached. Please check bridge server.');
                    }
                });
            }, 2000);
            
            // Initial fetch
            fetchRealData();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && event.target.id === 'userMessage') {
                sendUserMessage();
            }
        });

        // Auto-dismiss proactive alerts after 30 seconds
        setInterval(() => {
            const alert = document.getElementById('proactiveAlert');
            if (alert.style.display === 'block') {
                const alertTime = alert.dataset.showTime;
                if (alertTime && Date.now() - parseInt(alertTime) > 30000) {
                    alert.style.display = 'none';
                    addLogEntry('‚è∞ Proactive alert auto-dismissed after 30 seconds');
                }
            }
        }, 5000);

        console.log('üß†‚ù§Ô∏è CardioGuard Emotional AI - Advanced Health Companion');
        console.log('Features: Real-time biometric monitoring, emotional AI, proactive interventions');
        console.log('Network: Multi-device support with smart bridge detection');
        console.log('Privacy: Edge processing with secure data handling');
        console.log('Status: Ready for EmotiBit integration');
    </script>
</body>
</html>
